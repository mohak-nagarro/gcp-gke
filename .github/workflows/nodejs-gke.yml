name: Create GKE Cluster and Deploy App

on:
  workflow_dispatch:
    inputs:
      clusterName:
        description: 'Name of the GKE cluster'  
        required: true  
      location:
        description: 'GKE Region for the cluster'
        required: true
      appName:
        description: 'Name of the application to deploy'
        required: true
      repoUrl:
        description: 'Repository URL for image tagging'
        required: true
      # --- NEW CLUSTER SPECIFICATION PARAMETERS ---
      machineType:
        description: 'GKE Node Machine Type (e.g., e2-small, e2-medium)'
        required: false
        default: 'e2-small'
      nodeCount:
        description: 'Initial number of nodes in the cluster'
        required: false
        type: number
        default: 1
      gkeNetwork:
        description: 'VPC Network for the cluster'
        required: false
        default: 'backstage-vpc'
      gkeSubnetwork:
        description: 'Subnetwork for the cluster'
        required: false
        default: 'asia-south1'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: ${{ github.event.inputs.clusterName }}
  GKE_ZONE: ${{ github.event.inputs.location }}
  APP_NAME: ${{ github.event.inputs.appName }}
  # Define the image name for the container registry (e.g., GCR or Artifact Registry)
  IMAGE_NAME: gcr.io/${{ secrets.GCP_PROJECT_ID }}/${{ github.event.inputs.appName }}:${{ github.sha }}
  
  # --- NEW ENVIRONMENT VARIABLES FROM INPUTS ---
  GKE_MACHINE_TYPE: ${{ github.event.inputs.machineType }}
  GKE_NODE_COUNT: ${{ github.event.inputs.nodeCount }}
  GKE_NETWORK: ${{ github.event.inputs.gkeNetwork }}
  GKE_SUBNETWORK: ${{ github.event.inputs.gkeSubnetwork }}

jobs:
  create-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Authenticate to GCP
      - id: 'auth'
        name: 'Authenticate to GCP'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'
          
      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v3'

      - name: 'Use gcloud CLI'
        run: 'gcloud info'

      # 2. Create GKE Cluster
      - name: Create GKE cluster
        id: create-cluster
        run: |
          echo "Creating cluster $GKE_CLUSTER in $GKE_ZONE with machine type $GKE_MACHINE_TYPE and $GKE_NODE_COUNT nodes..."
          gcloud container clusters create $GKE_CLUSTER \
            --project=$PROJECT_ID \
            --region=$GKE_ZONE \
            --machine-type=$GKE_MACHINE_TYPE \
            --num-nodes=$GKE_NODE_COUNT \
            --enable-ip-alias \
            --network=$GKE_NETWORK \
            --subnetwork=$GKE_SUBNETWORK \
            --release-channel=regular \
            --workload-pool=$PROJECT_ID.svc.id.goog \
            --enable-autoupgrade \
            --enable-autorepair \
            --enable-shielded-nodes \
            --enable-network-policy
          echo "GKE cluster creation initiated."
      
      # 3. Checkout the Application Code (Crucial for Docker build)
      - name: Checkout Code
        uses: actions/checkout@v4
        # NOTE: If the Backstage template publishes to a *different* repo than where this workflow lives, 
        # you need a separate checkout step targeting the newly created repo/code base. 
        # For simplicity, we assume the content is now available locally.

      - name: Configure Docker Artifact Registry
        run: |
          gcloud auth configure-docker asia-south1-docker.pkg.dev
        
      - name: Build & Push Image to Artifact Registry
        run: |
          PROJECT=${{ secrets.GCP_PROJECT_ID }}
          REPO=nodeapps
          IMAGE=${{ github.event.inputs.appName }}
          TAG=${{ github.sha }}
          FULL_IMAGE="asia-south1-docker.pkg.dev/$PROJECT/$REPO/$IMAGE:$TAG"
          echo "Building image: $FULL_IMAGE"
          
          docker build -t "$FULL_IMAGE" .
          docker push "$FULL_IMAGE"
          
          echo "FULL_IMAGE=$FULL_IMAGE" >> $GITHUB_ENV
          
      # 5. Get Cluster Credentials
      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.GKE_CLUSTER }}
          location: ${{ env.GKE_ZONE }}
          project_id: ${{ env.PROJECT_ID }}
          
      - name: Apply Kubernetes manifests
        run: |
          sed -i "s|IMAGE_PLACEHOLDER|$FULL_IMAGE|g" k8s/deployment.yaml
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
              app: ${{ env.APP_NAME }}
          EOF
          
          echo "Deployment and Service for ${{ env.APP_NAME }} submitted to the cluster."
